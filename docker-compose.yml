services:
  # MongoDB - Primary Database
  quickbite-mongodb:
    image: mongo:7.0
    container_name: quickbite-mongodb
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    volumes:
      - mongodb_data:/data/db
    networks:
      - quickbite-network

  # Mongo Express - MongoDB GUI
  quickbite-mongo-express:
    image: mongo-express:1.0-20
    container_name: quickbite-mongo-express
    restart: unless-stopped
    ports:
      - "${MONGO_EXPRESS_PORT:-8081}:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_ROOT_USERNAME}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_ROOT_PASSWORD}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGO_ROOT_USERNAME}:${MONGO_ROOT_PASSWORD}@quickbite-mongodb:27017/
      ME_CONFIG_BASICAUTH: false
    depends_on:
      - quickbite-mongodb
    networks:
      - quickbite-network

  # Redis - Cache
  quickbite-redis:
    image: redis:7.2-alpine
    container_name: quickbite-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - quickbite-network

  # Redis Commander - Redis GUI
  quickbite-redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: quickbite-redis-commander
    restart: unless-stopped
    ports:
      - "${REDIS_COMMANDER_PORT:-8082}:8081"
    environment:
      REDIS_HOSTS: local:quickbite-redis:${REDIS_PORT:-6379}
    depends_on:
      - quickbite-redis
    networks:
      - quickbite-network

  # RabbitMQ - Message Broker
  quickbite-rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: quickbite-rabbitmq
    restart: unless-stopped
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"    # AMQP port
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"  # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - quickbite-network

  # User Service
  quickbite-user-service:
    build:
      context: .
      dockerfile: services/user-service/Dockerfile
    container_name: quickbite-user-service
    restart: unless-stopped
    ports:
      - "${USER_SERVICE_PORT:-3001}:3001"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3001
      LOG_LEVEL: ${LOG_LEVEL:-info}
      MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME}:${MONGO_ROOT_PASSWORD}@quickbite-mongodb:27017/${USER_DB:-user_service}?authSource=admin
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@quickbite-rabbitmq:5672
    depends_on:
      - quickbite-mongodb
      - quickbite-rabbitmq
    networks:
      - quickbite-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # Restaurant Service
  quickbite-restaurant-service:
    build:
      context: .
      dockerfile: services/restaurant-service/Dockerfile
    container_name: quickbite-restaurant-service
    restart: unless-stopped
    ports:
      - "${RESTAURANT_SERVICE_PORT:-3002}:3002"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3002
      LOG_LEVEL: ${LOG_LEVEL:-info}
      MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME}:${MONGO_ROOT_PASSWORD}@quickbite-mongodb:27017/${RESTAURANT_DB:-restaurant_service}?authSource=admin
      REDIS_URL: redis://quickbite-redis:6379
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@quickbite-rabbitmq:5672
    depends_on:
      - quickbite-mongodb
      - quickbite-redis
      - quickbite-rabbitmq
    networks:
      - quickbite-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # Order Service
  quickbite-order-service:
    build:
      context: .
      dockerfile: services/order-service/Dockerfile
    container_name: quickbite-order-service
    restart: unless-stopped
    ports:
      - "${ORDER_SERVICE_PORT:-3003}:3003"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3003
      LOG_LEVEL: ${LOG_LEVEL:-info}
      MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME}:${MONGO_ROOT_PASSWORD}@quickbite-mongodb:27017/${ORDER_DB:-order_service}?authSource=admin
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@quickbite-rabbitmq:5672
    depends_on:
      - quickbite-mongodb
      - quickbite-rabbitmq
    networks:
      - quickbite-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # API Gateway
  quickbite-api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    container_name: quickbite-api-gateway
    restart: unless-stopped
    ports:
      - "${API_GATEWAY_PORT:-3000}:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      LOG_LEVEL: ${LOG_LEVEL:-info}
      JWT_SECRET: ${JWT_SECRET}
      USER_SERVICE_URL: http://quickbite-user-service:3001
      RESTAURANT_SERVICE_URL: http://quickbite-restaurant-service:3002
      ORDER_SERVICE_URL: http://quickbite-order-service:3003
    depends_on:
      - quickbite-user-service
      - quickbite-restaurant-service
      - quickbite-order-service
    networks:
      - quickbite-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Driver Service
  quickbite-driver-service:
    build:
      context: .
      dockerfile: services/driver-service/Dockerfile
    container_name: quickbite-driver-service
    restart: unless-stopped
    ports:
      - "${DRIVER_SERVICE_PORT:-3004}:3004"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3004
      LOG_LEVEL: ${LOG_LEVEL:-info}
      MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME}:${MONGO_ROOT_PASSWORD}@quickbite-mongodb:27017/${DRIVER_DB:-driver_service}?authSource=admin
    depends_on:
      - quickbite-mongodb
    networks:
      - quickbite-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3004/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Notification Service
  quickbite-notification-service:
    build:
      context: .
      dockerfile: services/notification-service/Dockerfile
    container_name: quickbite-notification-service
    restart: unless-stopped
    ports:
      - "${NOTIFICATION_SERVICE_PORT:-3005}:3005"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3005
      LOG_LEVEL: ${LOG_LEVEL:-info}
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@quickbite-rabbitmq:5672
    depends_on:
      - quickbite-rabbitmq
    networks:
      - quickbite-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3005/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data:

networks:
  quickbite-network:
    driver: bridge
